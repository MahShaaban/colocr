---
title: "Using colocr"
subtitle: "An R package for conducting co-localization analysis"
author: "Mahmoud Shaaban"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using colocr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = 'center'
)
```

## Overview

A few R packages are available for conducting image analysis, which is a very wide topic. As a result, some of us might feel at loss when all they want to do is a simple co-localization calculations on a small number of microscopy images. This package provides a simple straight forward workflow for loading images, choosing regions of interest (ROIs) and calculating co-localization statistics. Included in the package, is a [shiny app](https://shiny.rstudio.com) that can be invoked locally to interactively select the regions of interest in a semi-automatic way. The package is based on the R package [`imager`](https://cran.r-project.org/web/packages/imager/vignettes/gettingstarted.html).


## Installing `colocr`

The package development version is available at [github](https://github.com/MahShaaban/colocr).

```{r install_github, eval=FALSE}
devtools::install_github('MahShaaban/colocr')
```


## Getting started

To get started, load the required packages and the images.
Then, apply the appropriate parameters for choosing the regions of interest
using the `roi_select`. Finally, check the appropriatness of the 
parameters by highlighting the ROIs on the image.

```{r getting_started, fig.width=5,fig.width=5}
# load libraries
library(imager)
library(colocr)

# load images
fl <- system.file('extdata', 'Image0001_.jpg', package = 'colocr')
img <- load.image(fl)

# choose parameters
px <- roi_select(img, threshold = 90)

# highlight chosen region of interest
par(mar=rep(0, 4))
plot(img, axes = FALSE)
highlight(px)
```

The same can be acheived interactively using an accompanying **shiny** app.
To launch the app run.

```{r run_app, eval=FALSE}
run_app()
```

The reset of the anlysis depends on the particular kind of images. Now, `colocr`
implements two simple colocalizations statistics; Pearson's Coefficeint Correlation [(PCC)](https://www.ncbi.nlm.nih.gov/pubmed/20653013) and the Manders Overlap Coefficient [(SCC)](https://en.wikipedia.org/wiki/Spearman%27s_rank_correlation_coefficient).

To apply both measures of correlation, we call `coloc_test` on the merge image.

```{r call_coloc_test}
corr <- coloc_test(img, px = px, type = 'all')

corr$p  # PCC
corr$r  # MOC
```

The same analysis and more can be conducted using a web interface for the package available [here](https://mahshaaban.shinyapps.io/colocr_app/)

## Detailed Example

The following example uses images from the [DU145](https://en.wikipedia.org/wiki/DU145) prostate cancer cell line. In this experiment, the cell line was treated with probes for two proteins [RKIP](https://en.wikipedia.org/wiki/Raf_kinase_inhibitor_protein) and [LC3](https://en.wikipedia.org/wiki/MAP1LC3B). The aim of this experiment is to determine, how much of the two proteins are co-localized or co-distrubuted in the particular cell line.  

```{r show_images, fig.width=7, fig.height=2.5}
# load required libraries
library(imager)
library(colocr)

# load images
img <- load.image(system.file('extdata', 'Image0001_.jpg', package = 'colocr'))       # merge
img1 <- channel(img, 1)  # red
img2 <- channel(img, 2)  # green

# show images
par(mfrow = c(1,3), mar = rep(1,4))
plot(img, axes = FALSE, main = 'Merged')
plot(img1, axes = FALSE, main = 'RKIP')
plot(img2, axes = FALSE, main = 'LC3')
```

The `colocr` package provides a straight forward workflow for determining the amount of colocalization. This workflow consists of two steps only:

  * Choosing regions of interest (ROI)
  * Calculating the correlation between the dyes from different channels

In addition the package provide functions to visualize these steps to make sure the choice of ROI is appropriate and that the calculated correlations are correct.

In the following section, we will explain the functionionality of the package by calling four different functions in order:

  * `roi_select`
  * `roi_show`
  * `coloc_test`
  * `coloc_show`

```{r workflow, echo=FALSE, out.width='300px'}
workflow_fig <- system.file('colocr_app', 'workflow.png', package = 'colocr')
knitr::include_graphics(workflow_fig)
```

### Choosing ROIs

The function `roi_select` relies on different algorithms from the `imager` package. However, using the functions to select the ROIs doesn't require any background knowledge in the workings of the algorithms and can be done through trying different parameters and choosing the most appropriate ones. The details of these parameters are documented in the function help page `?roi_select`.

```{r call_parameter_choos}
# choose parameters
px <- roi_select(img, threshold = 90)

# show pixset object structure
str(px)
```

Now, to make sure these parameters are appropriately encampasing the ROIs, call the `roi_show` to visualize side by side the original merge picture, a low resuliontion picture of the ROI and the images from the two different channels highlighted by the ROIs.

```{r call_roi_show, fig.width=7, fig.height=7}
# show parameters for selecting ROIs
par(mfrow=c(2,2), mar = rep(1, 4))
roi_show(img, px = px)
```

Arguable, this is the most time consuming step in this kind of analysis. Usually, one has to do this seleciton by hand when using image analysis software such as [imageJ]([CRAN](https://cran.r-project.org)). This package only semiautomate this step, but still relies on the user's judgment on which parameters to use and whether or not the selected ROIs are appropriate. To make life easier, the package provides a simple shiny app to interactively determine these parameters and use it in the rest of the workflow. To launch the app run the following

```{r run_app2, eval=FALSE}
# run the shiny app
run_app()
```

And here is a screen shot from the app after applying the sampe parameters used previously.

```{r app_screenshot, echo=FALSE, out.width="600px"}
# show the screen shot of the shiny app
app_ss <- system.file('colocr_app/tests/mytest-expected', '001.png', package = 'colocr')
knitr::include_graphics(app_ss)
```

Although this app was designed to be invoked from within the package to help the users to choose the selection parameters interactively. It's a stand alone app and can run the same analysis descriped here. The app can be accessed from the web [here](https://mahshaaban.shinyapps.io/colocr_app/)

### Calculating Correlation Statistics

The two different statistics implemented in this package are the PCC and SCC. The formal description and the rational for using them is detailed elsewhere.

Invoking the test is a one function call. 

```{r call_coloc_test2}
# Calculate the correlation statistics
corr <- coloc_test(img, px = px, type = 'all', num = TRUE)

corr$p  # PCC
corr$r  # MOC
```

Both co-localization statistics quantify different aspects of the linear trend between the pixel intensities from the two channels of the image. Therefore, it is useful to visualize this trend and the distribution of the intensities to make sure the analysis is appropriate.

```{r call_coloc_show, fig.width=7, fig.height=3}
# show the scatter and density of the pixel values
par(mfrow=c(1,2), mar = c(4,4,1,1))
coloc_show(corr)
```

### Choosing specific regions of interest

Some researchers recommend calculating the co-localization statistics for individual cells in the images, specially the PCC. Here, we can add labels to individual regions of interest which will be treated separatly in the subsequent calculation.

```{r labels_add}
# choose specific regions of interest
labs.px <- roi_select(img, threshold = 90, n = 3)
str(labs.px)
unique(as.numeric(labs.px[,,,1]))
```

The labeled regions of interest are highlighted and the rest is excluded.

```{r call_roi_show2, fig.width=7, fig.height=7}
# show parameters for the selected rois
par(mfrow=c(2,2), mar = rep(1, 4))
roi_show(img, px, labs.px)
```

The co-localization statistics for separate regions of interest.

```{r call_coloc_test3}
# apply colocalization stats on the specific rois
corr2 <- coloc_test(img, labs.px, type = 'all', num = TRUE)

corr2$p  # PCC
corr2$r  # MOC
```

```{r call_coloc_show2, fig.width=7, fig.height=3}
# show scatter and density of pixel values of rois
par(mfrow=c(1,2), mar = c(4,4,1,1))
coloc_show(corr2)
```

## Description of the co-localization statistics

The following is a brief discussion of the theory and interpretations of different statistics that we used in this package as a measure of co-localization. For through and formal details, check this article by [Dunn et al.](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3074624/).

### PCC

Pearson's Correlation Coefficient is the covariance of the pixel intensity from the two channels. The mean of the intensities is subtracted from each pixel which makes the coefficient independent of the background level.

The PCC is calculated as follows

$$
PPC = \frac{\sum_i{(R_i-\bar R)\times(G_i-\bar G)}}{\sqrt{\sum_i{(R_i-\bar R)^2\times\sum_i(G_i-\bar G)^2}}}
$$
Where $R_i$ and the $G_i$ is the intensities of the red and green channels and the $\bar R$ and $\bar G$ are the average intensities.

The values of PCC are between 1 and -1 for perfect correlations in the positive and negative directions respectively and 0 means no correltion.

### MOC

On the other hand, the Manders Overlap Coefficient doesn't require subtraction of the mean. Therefore, the values are always between 0 and 1. Also, the MOC is independent from signal proportionality. 

$$
MOC = \frac{\sum_i{(R_i\times G_i)}}{\sqrt{\sum_i{R_i^2\times\sum_i G_i^2}}}
$$
Where $R_i$ and the $G_i$ is the intensities of the red and green channels.

## Colocalization Benchmark Source

> The Colocalization Benchmark Source (CBS) is a free collection of downloadable images to test and validate the degree of colocalization of markers in fluorescence microscopy studies. It consists of computer-simulated images with exactly known (pre-defined) values of colocalization ranging from 0% to 90%. They can be downloaded as sets as well as separately.

Here, we used two examples from the CBS to test the results of the analysis using `colocr`.

```{r example1, fig.height=4, fig.width=4}
# load image
ex1 <- load.image(system.file('extdata', 'example1.png', package = 'colocr'))

# choose parameters (based on the app)
px <- roi_select(ex1, 
                       threshold = 90, 
                       shrink = 8)

# add labels
labs.px <- roi_select(ex1, 
                       threshold = 90, 
                       shrink = 8,
                       n = 50)

# show parameters
par(mfrow=c(2,2), mar = rep(1, 4))
roi_show(ex1, px, labs.px)

# test colocalization
corr <- coloc_test(ex1, labs.px, type = 'all')

# results
mean(corr$p, na.rm = TRUE)  # PCC
mean(corr$r)                # MOC
```

```{r example3, fig.height=4, fig.width=4}
# load image
ex3 <- load.image(system.file('extdata', 'example3.png', package = 'colocr'))

# choose parameters (based on the app)
px <- roi_select(ex3, 
                       threshold = 90, 
                       shrink = 9,
                       grow = 1,
                       fill = 10,
                       clean = 10)

# add labels
labs.px <- roi_select(ex3, 
                       threshold = 90, 
                       shrink = 9,
                       grow = 1,
                       fill = 10,
                       clean = 10,
                       n = 20)

# show parameters
par(mfrow=c(2,2), mar = rep(1, 4))
roi_show(ex3, px, labs.px)

# test colocalization
corr <- coloc_test(ex3, px, labs.px, type = 'all')

# results
mean(corr$p)
mean(corr$r)
```

## Acknowledgement

* The vignette images from [Lai Huyen Trang](https://www.researchgate.net/profile/Lai_Huyen_Trang)  
* The test examples from [Colocalization Benchmark Source (CBS)](https://www.colocalization-benchmark.com/index.html)  
* The implementation of the co-localization statistics from [Dunn et al.](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3074624/)  

